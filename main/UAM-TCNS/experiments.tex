% We use the reactive synthesis tool \texttt{Slugs}~\cite{EhlersR16} to compute the shields using the procedure described in Section~\ref{sec:distshield}.
% All experiments were  performed on an Intel i5-5300U 2.30 GHz CPU with 8 GB of RAM.
% \subsection{Shield synthesis comparison}
% We first compare the decentralized synthesis procedure presented in this paper with a centralized synthesis procedure detailed in \cite{multiagentshield}. In a centralized setting, the synthesis time grows exponentially with the number of vertihubs present and the number of vehicles used in the experiment.

% In each sector the safety specification $\varphi_i$ is to not exceed an upper bound of vehicles in each sector. For simplicity, we use the same contract values $\mathcal C_{\shield_j}^{\shield_i} = (A_{\shield_j}^{\shield_i},B_{\shield_j}^{\shield_i})$ referred to as $C$ in Table~\ref{tab:censynth} and maximum vehicle upper bound for the referred to as $N$ for all sectors, though, in principle, this is not necessary. 

% Again, we use the same $N$ for each sector. We compare the two procedures for increasing numbers of sectors in Table.~\ref{tab:censynth}. We report synthesis times for computing the permissive strategy, along with the time for computing the cost-optimal strategy from the permissive strategy. We use a cost function that assigns a cost whenever the shield moves an idle vehicle out of its region in order to disincentivize shields from moving vehicles when it is not required. 
\begin{figure}
    % \hfill 
    \centering
    \scalebox{0.75}{
\input{UAM-TCNS/Shield_Graph.tex}
}
        \caption{Implementation of the architecture in Figure~\ref{fig:dist_shield} for UAM ATM case study. }
	    \label{fig:exp_shield}
    \end{figure}



% \begin{table}[]
% \caption{Synthesis time comparison between centralized and localized methods.}\label{tab:censynth}
% \begin{tabular}{lllllll}
% \toprule
%  & Sectors & $N$ & $C$ & Perm. strategy time (s) & Opt. strategy time (s) &  \\
% \midrule
% \multicolumn{1}{c}{\multirow{4}{*}{\textbf{Centralized}}} & 3 & 2 & 2 & 43 & 17 &  \\
% \multicolumn{1}{c}{} & 5 & 3 & 3 & 1840 & 1489 &  \\
% \multicolumn{1}{c}{} & 7 & 4 & 4 & Time out & Time out &  \\
% \multicolumn{1}{c}{} & 9 & 5 & 5 & Time out & Time out &  \\ \hline
% \multirow{4}{*}{\textbf{Localized}} & 3 & 2 & 2 & 13 & 10 &  \\
%  & 5 & 3 & 3 & 123 & 32 &  \\
%  & 7 & 4 & 4 & 219 & 111 &  \\
%  & 9 & 5 & 5 & 470 & 286 & \\
%  \bottomrule
% \end{tabular}
% \end{table}

%Note that the decentralized synthesis procedure significantly outperforms the synthesis time of the centralized case. In the last two trials, the centralized shield synthesis timed out unsuccessfully.

\subsection{Simulation setting}
We demonstrate our approach on large-volume UAM air traffic data. The data used in the simulation was generated by NASA Langley in conjunction with partners performing UAM demand studies, and is in a format compatible with the Mission Planner Algorithm~\cite{guerreiro2019mission} developed at NASA Langley. The data contains simulated, timestamped on-demand requests for origin-destination trips. The dataset includes the position of 1000 vertiports shown in Figure~\ref{fig:vertipadlocations} which serve as the origin-destination pairs. 
In practice, the vertihub placement and size will correspond to physical infrastructure and we thus treat them as given inputs to the controller synthesis problem. While these decisions are beyond the scope of the work presented here, for this case study we select the vertihubs' centroids by using k-means clustering on the dataset vertiport locations shown in blue circles in Figure~\ref{fig:vertipadlocations}.


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.88\textwidth]{UAM-TCNS/pics/ports.eps}
	\caption{ Vertipad locations from NASA Langley dataset with corresponding vertihub controllers shown in blue circles}
	\label{fig:vertipadlocations}
\end{figure}


Requests are spawned when the timestamp corresponding to a trip request in the data is reached. Each vertihub handles the requests of the UAM vehicles as they come into range (defined by the circles in Figure~\ref{fig:sim}). \textcolor{black}{Note that increasing the number of vertihubs leads to the balkanization of the airspace.}



Each vehicle has a process flow from take-off to landing (Figure~\ref{fig:aircraftprocess}).
As a vehicle enters the range of a vertihub, it sends the vertihub controller a request to either land or pass through.
Then the vertihub controller sends one of three commands:
\begin{enumerate}
    \item If permission is granted to pass-through, the vehicle (green) flies to the next vertihub and requests access.
    \item If permission is granted to land, the vehicle (yellow) approaches the requested vertiport and sends a landing request to the vertiport controller.
    \item If neither permission is granted, the vehicle loiters (orange) and repeats its request.
 
\end{enumerate}

\begin{figure}
    \centering
    \scalebox{1}{\input{UAM-TCNS/flowchart.tex}}
    \caption[Process flow for an individual UAM moving through the environment.]{Process flow for an individual vehicle - during flight it checks whether it is in range of a vertihub. Once within range, the vehicle loiters and creates a request to either land or pass-through. The colors in the figure are used in the simulations to represent the current status of the vehicle.}
    \label{fig:aircraftprocess}
\end{figure}







%\subsection{Simulation Setting}
\label{ssec:SimSet}
When we describe interacting vertihubs, we refer to the segments where their regions of control overlap, see Fig.~\ref{fig:sim} for an example of an environment with sparse overlapping. Note that only the number of overlapping regions rather than the physical area of the overlapping regions is consequential to the aircraft's implemented behavior its process flow in Fig.~\ref{fig:aircraftprocess}.
In order to demonstrate the qualitative behavior of the global system, we examine the procedure with multiple operating vertihubs in three different settings where the vehicles are operating in: 
(i) an airspace covered by vertihubs that have many overlapping regions -- the many intersecting regions of control require a vehicle to receive many permissions to complete its mission.
(ii) \emph{sparsely interacting} vertihubs -- an airspace with only a few overlapping regions of control. Vehicles passing through these vertihubs negotiate few permissions.
 (iii) \emph{closely linked} vertihubs -- a special condition where the overall airspace has few overlapping regions of control but the overlapping regions are physically close together. In this scenario, the vehicles' missions compel them to pass through these regions simulating congestion a potential bottleneck. 

\begin{figure}
	\centering
	\includegraphics[width=0.75\textwidth]{UAM-TCNS/Towers.PNG}
	\caption[Screenshot of the UAM operations simulation environment ]{Screenshot of the simulation environment - green agents are in flight mode, orange agents are loitering, yellow agents are allocated for landing/passing-through and red agents are those that have landed. If a vertihub controller circle is red, then it will accept no more agents until the agents inside have landed or have been accepted to pass through to another region.
	}
	\label{fig:sim}
\end{figure}

All vertihub controllers must satisfy the following specifications: (1) landing or pass-through requests must be approved in less than $T$ steps and (2) there can be no more than $N$ vehicles in the region of the vertihub. 
All vertiport controllers must satisfy the following: no more than $M$ vehicles can land at any given time. The landing time is treated as an environment input and can vary based on the vehicle and weather conditions. The contract between the vertiport and vertihub states that a vertiport may not allow a vehicle to take off for up to $L$ steps and must clear a landing spot in at most $K$ steps. The vertihub controllers have contracts with connected controllers agreeing to let vehicles loiter in their regions for $t < T$ timesteps. These contracts allow vertihub controllers to land or let vehicles pass through while incoming vehicles loiter in neighboring regions.
The resulting video simulations for each setting can be seen in  \href{https://u-t-autonomous.github.io/Decentralized-UAM-Traffic-Management/}{https://u-t-autonomous.github.io/Decentralized-UAM-Traffic-Management/}.
\textcolor{black}{Also included in the link are further comparisons with different physical architectures for vertihub placement - in particular we compare scenario (i) when the airspace is covered by double the number of the vertihubs. The average loiter time for vehicles in setting (i) was approximately 3\% less per vehicle for the environment with more vertihubs, however, we note that this is not true in general and will depend on the specific network topology and specifications.}
Note that quantitative analysis and optimizing for minimum loiter times are of interest to this problem but the controllers operating in these case studies are only concerned with correctness.

\begin{figure}[h]
\centering
    \subfloat[Landing \label{fig:land}]{
    \includegraphics[width=0.32\textwidth]{UAM-TCNS/pics/sequence_100a.png}}~
    \subfloat[Free slot \label{fig:free}]{
\includegraphics[width=0.32\textwidth]{UAM-TCNS/pics/sequence_103a.png}}~
    \subfloat[Allocated \label{fig:allocate}]{
    \includegraphics[width=0.32\textwidth]{UAM-TCNS/pics/sequence_104a.png}}
    \caption{\textcolor{black}{Time sequence of a UAV landing ($1$) at a vertiport, which opens up a free slot for the vertihub ($2\rightarrow3$). The hub then allocates another UAV ($4\rightarrow 5$) to land at a free slot in one of the vertiports.}}
    \label{fig:sequence}
\end{figure}

\subsection{Qualitative results}

Figure~\ref{fig:sequence} contains an example of the allocation behavior for multiple agents approaching a single vertihub.
\textcolor{black}{Initially the vertihub is informed by the vertiports that there are no slots available for landing (see $2$ in Fig.~\ref{fig:land}). Subsequent to an agent landing ($1$ lands), an additional slot opens (see $3$ in Fig.~\ref{fig:free}).
Finally, the vertihub allocates a slot to a requesting vehicle ($4$ becomes $5$ in figure~\ref{fig:allocate}).} 

For each simulation setting, the vertihub interactions affect how vehicles are allocated and subsequently where they loiter.
In the case of (i), allocation bottlenecks tend to occur upon vehicle launch -- as a vehicle launches it waits for permission to move and thus bottlenecks are limited by the operating number of vehicles in the vertihub.
For (ii), there are significantly fewer bottlenecks but they mostly occur as vehicles either enter or exit a region.
For (iii) we observe the cascading of allocations in each region -- to allocate vehicles in the top region, the vehicles in the middle region must clear and similarly for the middle-lower region interactions.

\subsection{Synthesis time}

We present the synthesis times for the vertihub and vertiport controllers in Table~\ref{tab:hubsyntime}. 
There is an exponential increase in the synthesis time as the number of vertiports in each region is increased.
%Thus, this technique works best when there is not be a large number of vertiports assigned to each vertihub.
The state space of the controllers does not depend on the number of vehicles, allowing us to simulate datasets involving large numbers of vehicles. \textcolor{black}{
The centralized synthesis method in~\cite{bh18} could not be run even in the smallest case as the state space is too large. A decentralized, hierarchical procedure is necessary to handle systems of the necessary size and complexity that UAM will require. Other decentralized techniques such as~\cite{bhnfm} can only handle very restrictive classes of specifications and could not be used to generate controllers in this setting.}

We note that since the synthesis for each vertihub is independent of one another once the contracts are generated, the synthesis procedure for the global system is trivially parallelizable. 

\begin{table}[t!]
	\centering
	\caption{Synthesis times for vertihub/vertiport controllers}
	\label{tab:hubsyntime}
	\centering
	\scalebox{0.9}{
		\begin{tabular}{l>{\raggedleft}p{2.5cm}>{\raggedleft}p{2.0cm}>{\raggedleft\arraybackslash}p{1.5cm}}
			\toprule
			& No. of vertiports / No. of landing pads & No. of states in controller ($|Q_i|$) &  Synthesis time (s)  \\
			\midrule
			\multirow{3}*{Vertihub} & 3 & $2.1\times10^4$ & 22.75      \\
			& 4 & $2.7\times10^6$ & 1272.95  \\
			& 5 & $3.4\times10^8$ & 14300.65 \\
			\multicolumn{4}{@{}c@{}}{\makebox[\linewidth]{\dashrule[black]}}\\
			\multirow{3}*{Vertiport}&2 & $6.1\times10^2$ & 0.45      \\
			&4 & $4.3\times10^4$ & 19.12  \\
			&8 & $1.9\times10^8$ & 12403.86 \\
			\bottomrule
	\end{tabular}}
\end{table}
